---
title: "Post-processing Quality Assurance"
author: "Rick Gilmore"
date: "`r Sys.time()`"
output: 
  html_document:
    code_folding: hide
params:
  data_path: "~/Box Sync/Project_Sex_difference_on_Motion_Perception/data/raw_data"
  contrast_raw_path: "contrast_sensitivity_task_data"
  motion_raw_path: "motion_temporal_threshold_data"
  qualtrics_csv_dir: "qualtrics_survey_data/csv"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE,
                      message = FALSE)
library(tidyverse)
library(qualtRics)
```

## Purpose

This script describes the process for doing quality assurance (QA) review on each session.

## QA criteria

1. There are two datafiles for each participant:
  - One for the Abramov et al contrast sensitivity task `~/Box\ Sync/Project_Sex_difference_on_Motion_Perception/data/raw_data/contrast_sensitivity_task_data/`
  - One for the Murray et al temporal threshold task `~/Box\ Sync/Project_Sex_difference_on_Motion_Perception/data/raw_data/motion_sensitivity_task_data/`
2. There is survey data for each participant in `~/Box\ Sync/Project_Sex_difference_on_Motion_Perception/data/raw_data/qualtrics_data/`
3. There are four runs for each of two computer-based tasks, each run consisting of $n=30$ trials.
4. The computer-based tasks have recorded the participant gender.
6. The data files have recorded the participant ID and the participant ID matches the initial portion of the file name.
7. The data files include the most essential variables for analysis.

## QA steps

1. For each of the computer tasks
  - List the `*.csv` contrast files
2. Do lists align?
  - If not, do what?
5. Determine if QA has already been run.
  - How?
    - Determine if `*.html` file exists for this subject
6. If QA not-run, run QA.
  - Create `*.html` file from `*.Rmd` template.

## Post processing

### Create lists of `.csv` files

#### Contrast

```{r contrast-csvs}
contrast_csvs <- list.files(paste0(params$data_path, "/", params$contrast_raw_path), pattern = "\\.csv$")
contrast_csvs %>% knitr::kable(.)
```

There are `r length(contrast_csvs)` files for the Abramov contrast sensitivity task.

#### Motion

```{r motion-csvs}
motion_csvs <- list.files(paste0(params$data_path, "/", params$motion_raw_path), pattern = "\\.csv$")
motion_csvs %>% knitr::kable(.)
```

There are `r length(motion_csvs)` files for the Murray motion temporal threshold task.

## File by file QA

```{r define-qa-functions}
has_enough_trials <- function(data_df, n_trials = 4*30) {
  dim(data_df)[1] >= n_trials
}

observer_id_in_file <- function(data_df, task='contr') {
  if (task=='contr') {
    sum(!(is.na(data_df$Participant))) == length(data_df$Participant)
  } else {
    sum(!(is.na(data_df$observer))) == length(data_df$observer)
  }
}

gender_in_file <- function(data_df, task = 'contr') {
  if (task == 'contr') {
    sum(!(is.na(data_df$Gender))) > 0    
  } else {
    sum(!(is.na(data_df$gender))) > 0 
  }
}

sub_id_matches_fn <- function(data_fn, task='contr') {
  data_df <- readr::read_csv(data_fn)
  if (task=='contr') {
    sub_id <- as.character(data_df$Participant)
  } else {
    sub_id <- as.character(data_df$observer)
  }
  sub_id_fn <- stringr::str_extract(basename(data_fn), "[0-9]+")
  sum(sub_id == sub_id_fn) == length(sub_id)
} 

essential_vars_in_file <- function(data_df, task = 'contr') {
  if (task == 'contr') {
    essential_vars <- c("correctAns", "loop_trial.intensity", "loop_trial.thisN",
                                            "Participant", "Gender", "resp.rt")
  } else {
    essential_vars <- c("run_n", "correct", "trial_n", "stim_secs", "correct", "rt",
                        "observer", "FWHM", "actual_frame")
  }
  (sum(essential_vars %in% names(data_df)) == length(essential_vars))
}

make_qa_df <- function(data_fn, task = 'contr') {
  fn <- basename(data_fn)
  data_df <- readr::read_csv(data_fn)
  data.frame(fn,
             id_matches_fn = sub_id_matches_fn(data_fn, task),
             id_in_file = observer_id_in_file(data_df, task),
             enough_trials = has_enough_trials(data_df),
             has_key_vars = essential_vars_in_file(data_df, task),
             gender_var = gender_in_file(data_df, task)
             )
}
```

### Contrast

```{r contr-fns}
contr_fns <- contrast_csvs <- list.files(paste0(params$data_path, "/", params$contrast_raw_path), pattern = "\\.csv$", full.names = TRUE)
dfl <- lapply(contr_fns, make_qa_df, task = "contr")
contrast_file_qa <- Reduce(function(x,y) merge(x,y, all=TRUE), dfl)
contrast_file_qa %>% knitr::kable(.)
```

### Motion

```{r}
motion_fns <- list.files(paste0(params$data_path, "/", params$motion_raw_path), pattern = "\\.csv$", full.names = TRUE)
dfl <- lapply(motion_fns, make_qa_df, task = "motion")
motion_file_qa <- Reduce(function(x,y) merge(x,y, all=TRUE), dfl)
motion_file_qa %>% knitr::kable(.)
```

## Compare across tasks

```{r extract-sub-ids}
# Compare the two lists and determine the number of files uploaded to Box for each task.
extract_sub_ids <-
  function(df_path = paste0(paste0(params$data_path, "/", params$contrast_raw_path))) {
    fn_only <- list.files(paste0(df_path), pattern = "\\.csv$")
    stringr::str_sub(fn_only, 1, 16)
  }

contrast_sub_ids <-
  extract_sub_ids(paste0(params$data_path, "/", params$contrast_raw_path))

motion_sub_ids <-
  extract_sub_ids(paste0(params$data_path, "/", params$motion_raw_path))
```

Trim IDs to `YYYYMMDDHHMMSS` or 14 characters.

```{r}
contrast_sub_ids <- stringr::str_sub(contrast_sub_ids, 1, 14)
motion_sub_ids <- stringr::str_sub(motion_sub_ids, 1, 14)
```

Create helper function to detect duplicates.

```{r}
detect_duplicate_ids <- function(ids) {
  as.logical((sum(length(unique(ids)) != length(ids))))
}
```

### Constrast sub IDs

```{r}
sort(contrast_sub_ids)
```

These contrast file(s) have no matching motion file:

`r contrast_sub_ids[!(contrast_sub_ids %in% motion_sub_ids)]`

Are there duplicate contrast files? `r detect_duplicate_ids(contrast_sub_ids)`

### Motion sub IDs

```{r}
sort(motion_sub_ids)
```

These motion files have no matching contrast file:

`r motion_sub_ids[!(motion_sub_ids %in% contrast_sub_ids)]`

Are there duplicate motion files? `r detect_duplicate_ids(motion_sub_ids)`
