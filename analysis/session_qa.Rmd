---
title: "Post-processing Quality Assurance"
author: "Rick Gilmore"
date: "`r Sys.time()`"
output: 
  html_document:
    code_folding: hide
params:
  contrast_raw_path: "~/Box Sync/Project_Sex_difference_on_Motion_Perception/data/contrast_sensitivity_task_data"
  motion_raw_path: "~/Box Sync/Project_Sex_difference_on_Motion_Perception/data/motion_temporal_threshold_data"
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Purpose

This script describes the process for doing quality assurance (QA) review on each session.

## QA criteria

1. There are two datafiles for each participant:
  - One for the Abramov et al contrast sensitivity task `~/Box\ Sync/Project_Sex_difference_on_Motion_Perception/data/contrast_sensitivity_task_data/`
  - One for the Murray et al temporal threshold task `~/Box\ Sync/Project_Sex_difference_on_Motion_Perception/data/motion_sensitivity_task_data/`
2. There is survey data for each participant in `~/Box\ Sync/Project_Sex_difference_on_Motion_Perception/data/qualtrics_data/`
3. There are four runs for each of two computer-based tasks, each run consisting of $n=30$ trials.
4. The computer-based tasks have the participant gender.

## QA steps

1. For each of the computer tasks
  - Move `*.csv`, `*.pydat`, and `*.log` files to separate subdirectories.
  - List the `*.csv` contrast files
2. Do lists align?
  - If not, do what?
5. Determine if QA has already been run.
  - How?
    - Determine if `*.html` file exists for this subject
6. If QA not-run, run QA.
  - Create `*.html` file from `*.Rmd` template.

## Post processing

<!-- ### Copy files to `.csv`, `.psydat`, and `.log` directories -->

<!-- ```{r list-files} -->
<!-- # Now incorporated into copy_data_files() -->
<!-- # contrast_sens_files <- list.files(params$contrast_raw_path, pattern = "\\.csv$", full.names = TRUE) -->
<!-- # motion_thresh_files <- list.files(params$motion_raw_path, pattern = "\\.csv$", full.names = TRUE) -->
<!-- ``` -->

<!-- ```{r create-copy_data_files-function } -->
<!-- copy_data_files <- -->
<!--   function(df_path = params$contrast_raw_path, -->
<!--            df_type = "csv") { -->
<!--     these_files <- -->
<!--       list.files( -->
<!--         path = df_path, -->
<!--         pattern = paste0("\\.", df_type, "$"), -->
<!--         full.names = TRUE -->
<!--       ) -->
<!--     file.copy(from = these_files, to = paste0(df_path, "/", df_type, "/.")) -->
<!--   } -->
<!-- ``` -->

<!-- ```{r copy-contrast-sens-files} -->
<!-- copy_data_files(params$contrast_raw_path, df_type = "csv") -->
<!-- copy_data_files(params$contrast_raw_path, df_type = "log") -->
<!-- copy_data_files(params$contrast_raw_path, df_type = "psydat") -->
<!-- ``` -->

<!-- ```{r copy-motion-thresh-files} -->
<!-- copy_data_files(params$motion_raw_path, df_type = "csv") -->
<!-- copy_data_files(params$motion_raw_path, df_type = "psydat") -->
<!-- ``` -->

### Create lists of `.csv` files

```{r csv-file-lists}
contrast_csvs <- list.files(paste0(params$contrast_raw_path), pattern = "\\.csv$")
motion_csvs <- list.files(paste0(params$motion_raw_path), pattern = "\\.csv$")
```

There are `r length(contrast_csvs)` files for the Abramov contrast sensitivity task, and `r length(motion_csvs)` files for the Murray motion temporal threshold task.

```{r}
extract_sub_ids <- function(df_path = params$contrast_raw_path) {
  fn_only <- list.files(paste0(df_path), pattern = "\\.csv$")
  stringr::str_sub(fn_only, 1, 14)
}
```

```{r}
# Compare the two lists and determine the number of files uploaded to Box for each task.
contrast_sub_ids <- extract_sub_ids(params$contrast_raw_path)
motion_sub_ids <- extract_sub_ids(params$motion_raw_path)
```

```{r}
ids_identical <- (contrast_sub_ids == motion_sub_ids)

if (length(contrast_sub_ids) < length(motion_sub_ids)) {
  reference_ids <- contrast_sub_ids
  missing_ids <-
    motion_sub_ids[!(motion_sub_ids %in% contrast_sub_ids)]
  message(paste0(
    "File(s) ",
    missing_ids,
    " is/are missing from the contrast task.\n"
  ))
} else if (length(contrast_sub_ids) > length(motion_sub_ids)) {
  reference_ids <- motion_sub_ids
  missing_ids <-
    contrast_sub_ids[!(contrast_sub_ids %in% motion_sub_ids)]
  message(paste0(
    "File(s) ",
    missing_ids,
    " is/are missing from the motion task.\n"
  ))
} else if ((length(ids_identical) == length(contrast_sub_ids)) &&
              (length(ids_identical) == length(motion_sub_ids))) {
  message("There are the same number of files for both tasks and the sub_ids match.")
  reference_ids <- contrast_sub_ids
}
```

```{r}
id <- 1:max(length(reference_ids), length(reference_ids))

computer_task_df <- dplyr::tibble(id = id,
                                  contrast_task = contrast_sub_ids[contrast_sub_ids %in% reference_ids],
                                  motion_task = motion_sub_ids[motion_sub_ids %in% reference_ids])

computer_task_df <- computer_task_df %>%
  tidyr::gather(task, sub_id,-id)

computer_task_df %>%
  dplyr::group_by(., sub_id) %>%
  dplyr::summarise(n_tasks = n()) %>%
  knitr::kable(.)
```

